<!doctype html>
<html>
<head>
      <meta charset='utf-8' />
      <title>Mapping Memory Exercise</title>
      <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
      <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
      <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
      <style>
            body { margin:0; padding:0; }
            #map { position:absolute; top:0; bottom:0; width:100%; }
      </style>
</head>
      <body>
            <style>
                  #menu {
                        position: absolute; 
                        background: #fff;
                        padding: 10px;
                        font-family: 'Open Sans', sans-serif;
                  }
            </style>
            <div id='map'></div>
            <script>
                  var thesePlacesGeoJSON = [];
                  function getIconFromCategory (categoryString) {
                        switch (categoryString) {
                              case 'wealth':
                                    return '/UK/bank-15.svg'
                              case 'community':
                                    return '/UK/town-hall-15.svg'
                              case 'labor':
                                    return '/UK/industry-15.svg'
                              default:
                                    return 'bar'
                        }
                  };
                  function onEachFeature(feature, layer) { 
                        if (feature.properties && feature.properties.popupContent) { 
                              layer.bindPopup(feature.properties.popupContent); 
                        } 
                  };
                  L.mapbox.accessToken = 'pk.eyJ1IjoibWljaGFlbG5ldCIsImEiOiItbWFqc3BvIn0.iuqIsFSNd5Ut-5_1W4RR_g';
                  var map = L.mapbox.map('map').setView([53.105160, -4.006747], 9);
                  L.mapbox.styleLayer('mapbox://styles/michaelnet/ciutulpjz00152ipqoggp1xrl').addTo(map);
                  var myLayer = L.mapbox.featureLayer().addTo(map);
                  var xhr = new XMLHttpRequest();
                  xhr.onreadystatechange = function() {
                        var places = JSON.parse(this.responseText);
                        for (var i = 0; i < places.length; i++ ) {
                              var place = places[i];
                              thisPlaceGeoJSON = {
                                    type: 'Feature',
                                    geometry: {
                                          type: 'Point',
                                          coordinates: [
                                                place.longitude, 
                                                place.latitude
                                          ]
                                    },
                                    properties: {
                                          icon: {
                                                iconUrl: getIconFromCategory(place.category),
                                                iconSize: [50, 50],
                                                iconAnchor: [25, 25],
                                                popupAnchor: [0, -25],
                                                className: 'place'
                                          },
                                          popupContent: place.description
                                    }
                              }
                              myLayer.geoJSON(thisPlaceGeoJSON, { 
                                    onEachFeature: onEachFeature 
                              }).addTo(map);
                              thesePlacesGeoJSON.push(thisPlaceGeoJSON);
                        }
                  };
                  xhr.open("GET", "https://mappingmemory.github.io/UK/places.json");
                  xhr.send();
                  myLayer.on('layeradd', function(e) {
                        var marker = e.layer;
                        var feature = marker.feature;
                        marker.setIcon(L.icon(feature.properties.icon));
                  });
                  setTimeout(function() {
                        myLayer.setGeoJSON(thesePlacesGeoJSON);
                  }, 500)
</script>
</body>
</html>
